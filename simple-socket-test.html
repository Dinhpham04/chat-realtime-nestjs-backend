<!DOCTYPE html>
<html>

<head>
    <title>Simple Socket.IO Test</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .messages {
            height: 400px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: scroll;
            margin: 10px 0;
        }

        .input-group {
            margin: 10px 0;
        }

        .input-group input,
        .input-group button {
            margin: 5px;
            padding: 8px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸš€ Real-time Chat Test</h1>

        <div id="status" class="status disconnected">âŒ Disconnected</div>

        <div class="input-group">
            <input type="text" id="token" placeholder="JWT Token (leave empty for test)" style="width: 60%;">
            <button onclick="connect()">ğŸ”Œ Connect</button>
            <button onclick="disconnect()">âŒ Disconnect</button>
        </div>

        <div class="input-group">
            <input type="text" id="conversationId" placeholder="Conversation ID" value="conv_123">
            <button onclick="joinConversation()">ğŸ  Join Conversation</button>
        </div>

        <div class="input-group">
            <input type="text" id="messageText" placeholder="Type your message..." style="width: 60%;">
            <button onclick="sendMessage()">ğŸ“¤ Send Message</button>
        </div>

        <div class="input-group">
            <button onclick="testSequence()">ğŸ§ª Run Test Sequence</button>
            <button onclick="clearMessages()">ğŸ—‘ï¸ Clear Messages</button>
        </div>

        <div class="messages" id="messages">
            <div class="message">ğŸ’¡ <strong>Instructions:</strong></div>
            <div class="message">1. Click Connect (will use test token if empty)</div>
            <div class="message">2. Join a conversation</div>
            <div class="message">3. Send messages</div>
            <div class="message">4. Open multiple tabs to test real-time</div>
        </div>
    </div>

    <script>
        let socket = null;
        let messageCount = 0;

        function log(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';

            messagesDiv.innerHTML += `
                <div class="message ${className}">
                    <strong>[${timestamp}]</strong> ${message}
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(status, connected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = status;
            statusDiv.className = connected ? 'status connected' : 'status disconnected';
        }

        function connect() {
            let token = document.getElementById('token').value;

            // If no token provided, try without authentication for test
            if (!token) {
                token = 'test_token_' + Math.random().toString(36).substr(2, 9);
                log('ğŸ”§ Using test token (auth may fail)', 'info');
            }

            const deviceId = 'web_test_' + Math.random().toString(36).substr(2, 9);

            log(`ğŸ”Œ Connecting to Socket.IO server...`);
            log(`Device ID: ${deviceId}`);

            socket = io('http://localhost:3000/chat', {
                auth: {
                    token: token,
                    deviceId: deviceId,
                    deviceType: 'web',
                    platform: 'web'
                },
                transports: ['websocket', 'polling'],
                timeout: 10000
            });

            // Connection events
            socket.on('connect', () => {
                updateStatus('âœ… Connected', true);
                log(`âœ… Connected! Socket ID: ${socket.id}`, 'success');
            });

            socket.on('disconnect', (reason) => {
                updateStatus('âŒ Disconnected', false);
                log(`âŒ Disconnected: ${reason}`, 'error');
            });

            socket.on('connect_error', (error) => {
                updateStatus('âŒ Connection Error', false);
                log(`âŒ Connection Error: ${error.message}`, 'error');
                log('ğŸ’¡ Try using a valid JWT token or check server logs', 'info');
            });

            // Message events
            socket.on('message_received', (data) => {
                log(`âœ… Message ACK: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('message_error', (data) => {
                log(`âŒ Message Error: ${JSON.stringify(data)}`, 'error');
            });

            socket.on('new_message', (data) => {
                log(`ğŸ“¨ New Message: "${data.content}" from ${data.senderName || data.senderId}`, 'success');
            });

            socket.on('delivery_updates_batch', (data) => {
                log(`ğŸ“‹ Delivery Updates: ${data.updates.length} updates`);
            });

            socket.on('read_receipts_batch', (data) => {
                log(`ğŸ‘ï¸ Read Receipts: ${data.messageIds.length} messages read by ${data.userId}`);
            });

            socket.on('offline_messages_batch', (data) => {
                log(`ğŸ“¥ Offline Messages: ${data.messages.length} messages delivered`, 'success');
            });

            // Generic event listener for debugging
            socket.onAny((event, ...args) => {
                if (!['connect', 'disconnect', 'connect_error'].includes(event)) {
                    log(`ğŸ”” Event: ${event} - ${JSON.stringify(args)}`);
                }
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                updateStatus('âŒ Disconnected', false);
                log('âŒ Manually disconnected');
            }
        }

        function joinConversation() {
            if (!socket || !socket.connected) {
                alert('Please connect first!');
                return;
            }

            const conversationId = document.getElementById('conversationId').value;
            if (!conversationId) {
                alert('Please enter conversation ID');
                return;
            }

            log(`ğŸ  Joining conversation: ${conversationId}`);
            socket.emit('join_conversations', {
                conversationIds: [conversationId]
            });
        }

        function sendMessage() {
            if (!socket || !socket.connected) {
                alert('Please connect first!');
                return;
            }

            const messageText = document.getElementById('messageText').value;
            const conversationId = document.getElementById('conversationId').value;

            if (!messageText || !conversationId) {
                alert('Please enter message and conversation ID');
                return;
            }

            const localId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            messageCount++;

            const messageData = {
                localId: localId,
                conversationId: conversationId,
                content: messageText,
                type: 'text',
                timestamp: Date.now()
            };

            log(`ğŸ“¤ Sending message #${messageCount}: "${messageText}"`);
            socket.emit('send_message', messageData);

            // Clear input
            document.getElementById('messageText').value = '';
        }

        function testSequence() {
            if (!socket || !socket.connected) {
                alert('Please connect first!');
                return;
            }

            log('ğŸ§ª Running test sequence...', 'info');

            // Join conversation
            setTimeout(() => {
                document.getElementById('conversationId').value = 'conv_test_123';
                joinConversation();
            }, 500);

            // Send test messages
            const testMessages = [
                'Hello World! ğŸŒ',
                'Testing real-time messaging ğŸš€',
                'This is message number 3',
                'Final test message âœ…'
            ];

            testMessages.forEach((msg, index) => {
                setTimeout(() => {
                    document.getElementById('messageText').value = msg;
                    sendMessage();
                }, 1000 + (index * 1500));
            });

            // Simulate read receipt
            setTimeout(() => {
                log('ğŸ“– Simulating read receipt...');
                socket.emit('mark_as_read', {
                    conversationId: 'conv_test_123',
                    messageIds: ['msg_1', 'msg_2'],
                    userId: 'test_user',
                    readAt: Date.now()
                });
            }, 8000);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = `
                <div class="message">ğŸ’¡ <strong>Messages cleared</strong></div>
            `;
        }

        // Handle Enter key in message input
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('messageText').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        // Auto-connect on page load for testing
        window.onload = function () {
            log('ğŸ”„ Page loaded. Ready for testing!');
        };
    </script>
</body>

</html>